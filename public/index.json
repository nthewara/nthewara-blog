
[{"content":"","date":"2025-12-07","externalUrl":null,"permalink":"/","section":"","summary":"","title":"","type":"page"},{"content":"","date":"2025-12-07","externalUrl":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":" Introduction # Microsoft Foundry (Previously called AI Foundry) provides powerful capabilities for building and deploying AI agents and solutions. For enterprise customers, securing these deployments within their own network infrastructure is critical for compliance, governance, and integration with existing landing zones. The Bring Your Own (BYO) VNET deployment pattern enables organizations to secure and control both inbound and outbound access to Foundry Agent services while maintaining network isolation. In this blog post, I\u0026rsquo;m sharing lessons learned from a recent Microsoft Foundry Agent Service deployment utilising the BYO VNET pattern. This approach is particularly valuable for organizations that need to:\nIntegrate Microsoft Foundry with existing hub and spoke network architecture Enforce strict network security policies Maintain compliance with regulatory requirements Control data flow and access patterns Understanding AI Foundry Versions # It\u0026rsquo;s important to note that there are multiple versions of AI Foundry in documentation. This blog focuses on Microsoft Foundry Classic Service. For a detailed explanation of the differences between Hub based and Project based Foundry experiences, refer to this blog. Network Security Architecture Overview # When deploying Microsoft Foundry using the BYO VNET approach, there are three critical security layers to configure:\nIndividual Resource Configuration - Network access settings for each Azure resource Network Security Groups (NSGs) - Subnet level traffic filtering for the delegated Microsoft Foundry subnet Azure Firewall Configuration - Centralised outbound access control Prerequisites # Before deploying Microsoft Foundry with BYO VNET, ensure you have:\nAn existing VNET with available address space for dedicated subnets Azure Firewall or equivalent network virtual appliance Appropriate Azure RBAC permissions to create resources and configure networking Understanding of your organization\u0026rsquo;s network architecture and security requirements Deployment # Foundry team has published templates for both Bicep and Terraform that can be used for creating Foundry deployment using customer owned VNET. This deployment template requires below resources for a successful deployment\n1. Agent Subnet with Delegation\nRecommended minimum size: /26 or larger depending on scale requirements Agent subnet delegated to Foundry with Subnet delegation using \u0026ldquo;Microsoft.App/environments\u0026rdquo; as below 2. Private Endpoints Subnet\nDedicated subnet for hosting private endpoints to Microsoft Foundry resources No delegation required Recommended size: /27 or larger Required Private DNS Zones # Microsoft Foundry Agent Service must be able to resolve private endpoints. This can be achieved by either:\nDirectly linking Private DNS zones to your VNETs, or Using custom DNS configuration on the VNET pointing to Azure Private DNS Resolver or other DNS resolver service Required DNS zones:\nprivatelink.blob.core.windows.net privatelink.cognitiveservices.azure.com privatelink.documents.azure.com privatelink.openai.azure.com privatelink.search.windows.net privatelink.services.ai.azure.com privatelink.file.core.windows.net Network Security Group Configuration # NSG configuration is critical for controlling outbound access from the Microsoft Foundry delegated agent subnet. The following outbound rules represent the minimum required configuration:\nNSG Rules # 1. Entra ID Access (Azure Active Directory)\nService Tag: AzureActiveDirectory Required for identity access Port: 443 (HTTPS) 2. Container Apps Management\nService Tag: AzureContainerAppsManagement Required for Container Apps platform management Port: 443 3. Container Registry\nService Tag: AzureContainerRegistry Required for pulling container images Port: 443 4. Foundry Infra Communication\nDestination: - 100.67.0.0/24 Foundry Infra Communication Ports: Any Azure Firewall Configuration # Azure Firewall provides centralised control over outbound traffic from the Microsoft Foundry environment. Azure firewall processes rules in the following order:\nNetwork Rules - Processed first Application Rules - Processed if no network rule match Network Rules Configuration # Configure network rules to allow traffic to Azure service tags:\nAzureActiveDirectory - Port 443 InternalACATraffic Allow \u0026ldquo;100.67.0.0/24\u0026rdquo; range which is used by Agent Infra communication\nApplication Rules Configuration # Application rules provide FQDN-based filtering for outbound HTTPS traffic to specific domains required by Microsoft Foundry services.\nResource Configuration # All Microsoft Foundry related resources should be configured with network security in mind and with disabled public access.\nMicrosoft Foundry resource network configuration below Delegated subnet configuration Cosmos DB Network configuration - Disabled Public Access AI Search Network configuration - Disabled Public Access Azure Storage Network configuration - Disabled Public Access Foundry Agent Validation # After deployment, validate Microsoft Foundry Agent service functions correctly:\n1. Create a New Agent # Use Microsoft Foundry Portal to create and configure a new agent. Successful agent creation indicates proper network connectivity and resource access.\n2. Upload Knowledge Files # Test file upload functionality, which demonstrates:\nAzure Storage connectivity via private endpoint AI Search integration for vector database population Authentication through Entra ID 3. Test Chat Playground # Validate agent responses using the chat playground. This tests:\nEnd to end agent functionality Knowledge retrieval from vector store LLM endpoint connectivity (Using GPT4o in this example) Thread logs functionality to trace requests This is another example where we are asking a relevant questions with knowledge provided (Microsoft annual report 2025). We get expected response with reference to uploaded content.\n4. Review Thread Logs # Use the built-in thread logs functionality to:\nObserve tool calls against the vector store Validate response generation Troubleshoot any issues with agent behavior Observability # Comprehensive observability is essential for operating Microsoft Foundry in production. Enable diagnostic logging across all components to gain visibility into traffic flows and request patterns.\nObservability - \u0026gt; Firewall # Having logs enabled on the firewall allows us to observe traffic flows from Microsoft Foundry delegated subnet. Looking at logs below, we can see communication from Foundry subnet, towards Microsoft Container Registry and towards Azure Container Apps endpoints.\nApplication Rule Logs below Network Rule Logs below Observability -\u0026gt; VNET Flow Logs # Below are logs from the VNET hosting agents. We can observe ACA Traffic reaching Microsoft managed endpoinst\nObservability -\u0026gt; Microsoft Foundry Logs # Foundry Logs also demonstrates requests from User towards Foundry Private Endpoints and other services reaching foundry service. Observability -\u0026gt; CosmosDB Logs # We are also able to see request logs from CosmosDB Logs showcasing request from Agent delegated Subnet. Conclusion # Deploying Microsoft Foundry using the Bring Your Own VNET pattern provides enterprise grade security and network control for AI agent workloads. This blog post has demonstrated a comprehensive approach to securing Microsoft Foundry deployments through three critical layers: individual resource network configuration, subnet NSG rules, and centralised Azure Firewall policies.\nKey Takeaways # Security in Depth: BYO VNET pattern enables defense in depth by combining multiple security controls from resource level private endpoints to network level traffic filtering. This layered approach ensures that Microsoft Foundry deployments meet enterprise security requirements while maintaining full functionality.\nPrivate Endpoints Are Critical: All Microsoft Foundry resources should be configured with disabled public network access and accessed exclusively through private endpoints. This ensures traffic remains within your virtual network and integrates seamlessly with existing Azure landing zone.\nObservability is Essential: Comprehensive logging across Azure Firewall, VNET Flow Logs, and resource specific diagnostics provides the visibility needed to troubleshoot issues, optimize performance, and maintain security compliance. The investment in proper logging pays dividends during operations.\n","date":"2025-12-07","externalUrl":null,"permalink":"/posts/securingmicrosoftfoundrywithbyovnet/","section":"Posts","summary":"","title":"Securing Microsoft Foundry with Bring Your Own VNET","type":"posts"},{"content":" Introduction # This blog post shares an engineering validated pattern for establishing connectivity between Azure Extended Zones and Azure Virtual WAN environments. Currently, Virtual WAN hubs cannot be deployed within Extended Zones, so we need alternative approaches to bridge these environments.\nBelow is a summary of connectivity options for Extended Zone\nConnectivity Options for Extended Zones # Customer Scenario Approach Customer with Traditional Hub \u0026amp; Spoke VNet and looking to connect to Azure Region (eg Azure AU East) Utilise Global VNet Peering for connecting from Extended Zone to Azure Region Customer with Traditional Hub \u0026amp; Spoke VNet and connect to on-premises (using Perth Edge) Utilise ExpressRoute Connectivity or SD-WAN / VPN Connectivity using Network Virtual Appliance (NVA) Customer with Virtual WAN and looking to connect to Azure Region from Extended Zone (eg Ex Zone Perth -\u0026gt; Azure AU East) Create Traditional VNet Hub \u0026amp; Spoke pattern in Extended Zone and utilise ExpressRoute Circuit for connectivity to Virtual WAN hub in Azure Region Supported Networking Services for Extended Zones (Sept-2025) # Virtual Network Standard Public IP Standard Load Balancer ExpressRoute Circuits and ExpressRoute Gateways Virtual Network Peering (Local and Global) Private Link Virtual Network Appliances (NVAs) Services that are currently not available (Sept-2025) # Virtual WAN VPN Gateway For this blog post, we\u0026rsquo;ll cover 3rd scenario where a customer already has Virtual WAN environment and looking to establish connectivity to Extended Zones\nConfiguration # This setup follows the same configuration pattern used for establishing coexistence between Hub-Spoke environments and Virtual WAN. The key requirement is enabling bidirectional traffic flow between the two gateway types.\nEssential Configuration Settings:\nHub-Spoke ExpressRoute Gateway: Enable \u0026ldquo;Allow traffic from remote Virtual WAN networks\u0026rdquo; Virtual WAN ExpressRoute Gateway: Enable \u0026ldquo;Allow traffic from non Virtual WAN networks\u0026rdquo; Below is my ExpressRoute Gateway deployed to Extended Zone VNet. Below configuration enables ExpressRoute Gateway to receive routes from Virtual WAN ExpressRoute Gateway Validating Connectivity # Step 1: Verify Extended Zone VM Routes # First, validate that VMs in the Extended Zone are learning routes from the Virtual WAN environment through the ExpressRoute Gateway.\nEffective routes from my VM in Perth Extended Zone show routes learned from ExpressRoute Gateway and these are remote routes from my Virtual WAN environment.\nStep 2: Validate Virtual WAN Environment Routes # Next, verify that VMs connected to the Virtual WAN hub are learning Extended Zone VNet prefixes.\nBelow routes are learned by my virtual machine connected to Virtual WAN hub that is hosting ExpressRoute Gateway and we are able to see Extended Zone VNet prefixes are learned by the network interface attached to my VM.\nStep 3: Check Virtual WAN hub Effective Routes # For deeper insight into routing behavior, examine the effective routes from the Virtual WAN hub. This view helps understand:\nAS Path information All prefixes learned by the ExpressRoute Gateway Route propagation between environments Additional Considerations # Bandwidth Constraints: ExpressRoute Gateway bandwidth is limited by the gateway SKU configuration\nAdditional Latency: The gateway hop introduces additional latency to traffic flows between environments\nConclusion # If you are already using Virtual WAN network deployment, you can now take full advantage of Extended Zones by connecting to your existing Virtual WAN environment using your current ExpressRoute connectivity.\n","date":"2025-08-31","externalUrl":null,"permalink":"/posts/azureextendedzonevwan/","section":"Posts","summary":"","title":"Azure Extended Zone Connectivity to Virtual WAN","type":"posts"},{"content":" Introduction # This blog post shares an engineering validated pattern for establishing connectivity between Azure Extended Zones and Azure Virtual WAN environments. Currently, Virtual WAN hubs cannot be deployed within Extended Zones, so we need alternative approaches to bridge these environments.\nBelow is a summary of connectivity options between Extended Zones and Azure regions:\nConnectivity Options for Extended Zone to Azure Region # Connectivity Method Hub-Spoke Environment Virtual WAN Environment Global VNET Peering Recommended option for connecting Hub-Spoke network hubs Not supported when hosting a gateway in Extended Zone VNET SD-WAN Network Virtual Appliance Establish connectivity using SD-WAN tunnels Establish connectivity using SD-WAN tunnels ExpressRoute Not recommended due to added latency and bandwidth constraints Recommended option given current lack of Virtual WAN hub support in Extended Zones For this implementation, we\u0026rsquo;ll use ExpressRoute to connect the Extended Zone environment to other Azure regions.\nConfiguration # This setup follows the same configuration pattern used for establishing coexistence between Hub-Spoke environments and Virtual WAN. The key requirement is enabling bidirectional traffic flow between the two gateway types.\nEssential Configuration Settings:\nHub-Spoke ExpressRoute Gateway: Enable \u0026ldquo;Allow traffic from remote Virtual WAN networks\u0026rdquo; Virtual WAN ExpressRoute Gateway: Enable \u0026ldquo;Allow traffic from non Virtual WAN networks\u0026rdquo; Below is my ExpressRoute Gateway deployed to Extended Zone VNET. Below configuration enables ExpressRoute Gateway to recieve routes from Virtual WAN ExpressRoute Gateway Validating Connectivity # Step 1: Verify Extended Zone VM Routes # First, validate that VMs in the Extended Zone are learning routes from the Virtual WAN environment through the ExpressRoute Gateway.\nEffective routes from my VM in Perth Extended Zone shows routes learned from ExpressRoute Gateway and these are remote routes from my Virtual WAN environment.\nStep 2: Validate Virtual WAN Environment Routes # Next, verify that VMs connected to the Virtual WAN hub are learning Extended Zone VNET prefixes.\nBelow routes are learned by my virtual machine connected to Virtual WAN hub that is hosting ExpressRoute Gateway and we are able to see Extended Zone VNET prefixes are learned by the network interface attached to my VM.\nStep 3: Check Virtual WAN Hub Effective Routes # For deeper insight into routing behavior, examine the effective routes from the Virtual WAN Hub. This view helps understand:\nAS Path information All prefixes learned by the ExpressRoute Gateway Route propagation between environments Additional Considerations # Bandwidth Constraints: ExpressRoute Gateway bandwidth is limited by the gateway SKU configuration\nAdditional Latency: The gateway hop introduces extra latency to traffic flows between environments\nConclusion # If you are already using Virtual WAN network deployment, you can now take full advantage of Extended Zones by connecting to your existing Virtual WAN environment using your current ExpressRoute connectivity.\n","date":"2025-07-29","externalUrl":null,"permalink":"/posts/virtualwanexpressrouteroutemaps/","section":"Posts","summary":"","title":"Virtual WAN ExpressRoute together with RouteMaps","type":"posts"},{"content":" Introduction # Migrating from a traditional hub-and-spoke Virtual Network (VNET) architecture to Azure Virtual WAN can seem complex \u0026amp; challenging, but establishing coexistence between both environments during the transition makes the process smoother and reduces risk. This post walks you through the most efficient approach for maintaining connectivity during your migration.\nWhen planning your Virtual WAN migration, you have several connectivity options to bridge your existing and new environments\nUtilise ExpressRoute Circuit Utilise Site to Site VPN Connectivity using VPN Gateways Utilise SD-WAN Connectivity using SD-WAN NVAs Utilise On-premises traffic routing Recommended Approach: If your existing environment already uses ExpressRoute, this is the most straightforward and cost-efficient coexistence strategy. However, recent Azure changes require specific configuration steps to ensure proper route propagation between environments. I have detailed below, configuration required to make this scenario work in your environment.\nStep 01 -\u0026gt; Enable \u0026ldquo;Allow traffic from remote Virtual Networks\u0026rdquo; in your existing Traditional Hub Spoke ExpressRoute Gateway # This option allows Virtual WAN routes to be propagated to existing traditional hub spoke environment. Without this, routes wont be learned and this option is not enabled by default. Step 02 -\u0026gt; Enable \u0026ldquo;Allow traffic from non Virtual WAN networks\u0026rdquo; in your Virtual WAN Hub # This options allows routes learned by tranditional hub spoke environment to be propagated to Virtual WAN Hubs. This option is also disabled by default. Step 03 -\u0026gt; Connect existing ExpressRoute Circuit to Virtual WAN Hub # This establishment allows routes to be exchanged between existing hub spoke environment and new virtual wan environment\nOnce we have established connectivity, next we can validate route exchange between existing and new environments\nStep 04 - Verify Virtual WAN effective Routes # Effective routes show us learned routes and we can see routes learned via 12076 AS Path. These are routes learned from remote traditional hub spoke environment\nStep 05 - Verify Traditional Hub Spoke Environment # To verify traditional Hub Spoke environment, we will utilise powershell and list learned routes on the ExpressRoute Gateway\n$rg = \u0026#39;ntvwanmig-fvvw\u0026#39; $gw = \u0026#39;ntvwanmig-ergw-fvvw\u0026#39; Get-AzVirtualNetworkGatewayLearnedRoute ` -ResourceGroupName $rg ` -VirtualNetworkGatewayName $gw Below is the output from traditional Hub Spoke ExpressRoute Gateway. This is demonstrating gateway learning routes from Virtual WAN environment via existing ExpressRoute Circuit and using AS Path 12076. We can also verify routes learned by the ExpressRoute Circuit using below command\n$rg = \u0026#39;ntvwanmig-fvvw\u0026#39; $erc = \u0026#39;ntvwanmig-er-circuit-fvvw\u0026#39; Get-AzExpressRouteCircuitRouteTable -ResourceGroupName $rg ` -ExpressRouteCircuitName $erc ` -PeeringType \u0026#34;AzurePrivatePeering\u0026#34; ` -DevicePath \u0026#34;Primary\u0026#34; Below output confirms routes learned via traditional Hub Spoke ER Gateway and Virtual WAN Hub ER gateway. Note that these routes are all learned via AS 65515 which is assigned to each of the gateways in vWAN and Hub Spoken environment. VMs from existing environment can now reach new Virtual WAN environment I have also created a video demonstrating this scenario below Key Takeaways # Planning is crucial: Understand your connectivity options before beginning migration Configuration order matters: Follow the steps in sequence for successful coexistence Verification is essential: Use both Azure portal and PowerShell to confirm proper route propagation ExpressRoute is optimal: If already in use, ExpressRoute provides the most cost-effective coexistence solution Conclusion # Establishing coexistence between traditional hub-and-spoke and Virtual WAN environments doesn\u0026rsquo;t have to be complex. By following these configuration steps and properly verifying route propagation, you can ensure smooth connectivity during your migration process. This approach minimises downtime and reduces the risk associated with large-scale network changes.\n","date":"2025-07-25","externalUrl":null,"permalink":"/posts/vwanhubspokemigration/","section":"Posts","summary":"","title":"Migrate from Hub-Spoke to Azure Virtual WAN ExpressRoute Coexistence Guide","type":"posts"},{"content":" This is a test post # ","date":"2025-07-11","externalUrl":null,"permalink":"/posts/test2/","section":"Posts","summary":"","title":"Test2","type":"posts"},{"content":" BGP Authentication with MD5 Hash # What is BGP MD5 Authentication? # BGP MD5 authentication is a security mechanism where BGP peers use a shared secret key to authenticate their communications. When enabled, each BGP message includes an MD5 hash calculated from the message content plus the shared key. The receiving peer calculates the same hash and compares it to verify the message came from an authenticated source.\nHow MD5 Hash Works # MD5 (Message Digest 5) is a cryptographic hash function that takes input data of any size and produces a fixed 128-bit (16-byte) hash value, typically represented as a 32-character hexadecimal string. Key properties:\nDeterministic: Same input always produces the same hash Fast computation: Quick to calculate Avalanche effect: Small input changes create drastically different outputs Fixed output size: Always 128 bits regardless of input size For BGP authentication, the hash is calculated over the BGP message plus the shared key, creating a unique fingerprint that proves the sender knows the secret.\nBenefits of Using MD5 Authentication # Peer Authentication: Prevents unauthorized routers from establishing BGP sessions with your router Message Integrity: Detects if BGP messages have been tampered with during transmission Protection Against Injection: Stops attackers from injecting malicious route advertisements Session Hijacking Prevention: Makes it extremely difficult for attackers to take over established BGP sessions Compliance: Many enterprise and service provider networks require authentication for security policies Without MD5 Authentication # When you don\u0026rsquo;t use a shared key:\nNo Authentication: Any router that knows your IP address and AS number can potentially establish a BGP session No Message Integrity: Corrupted or modified messages might be accepted Vulnerability to Attacks: Susceptible to BGP hijacking, route injection, and man-in-the-middle attacks Easier Misconfigurations: Accidental peering with wrong neighbors is more likely to succeed undetected Important Security Note # While MD5 was widely used historically, it\u0026rsquo;s now considered cryptographically weak due to known collision vulnerabilities. Modern implementations should prefer stronger alternatives like SHA-256 or TCP Authentication Option (TCP-AO) where supported. However, MD5 authentication still provides significant security benefits over no authentication at all, especially in controlled environments like ExpressRoute where the physical infrastructure is managed by the service provider.\n","date":"2025-07-10","externalUrl":null,"permalink":"/posts/expressroute-shared-key/","section":"Posts","summary":"","title":"ExpressRoute Shared Key","type":"posts"},{"content":" Coming Soon # ","externalUrl":null,"permalink":"/about/","section":"","summary":"","title":"About Me","type":"page"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":" Coming Soon # ","externalUrl":null,"permalink":"/resources/","section":"","summary":"","title":"Resources","type":"page"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"},{"content":"","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"}]